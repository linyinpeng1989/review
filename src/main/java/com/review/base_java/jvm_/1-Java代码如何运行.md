[《深入拆解 Java 虚拟机》01 | Java代码是怎么运行的？](https://time.geekbang.org/column/article/11289)

---

### 1、为什么Java要在虚拟机中运行？
Java作为一门高级程序语言，语法非常复杂，抽象程度也很高。因此直接在硬件上运行这种复杂的程序并不现实，需要在运行Java程序之前对其进行一番转换。当前主流的思路是这样子的，设计一个面向 Java 语言特性的
虚拟机，并通过编译器将 Java 程序转换成该虚拟机所能识别的指令序列，也称 Java 字节码。


- 虚拟机的好处
    - 虚拟机一般是在各个现有平台（如Windows、Linux等）提供软件实现，所以一旦程序被转换成Java字节码，便可以在不同平台上的虚拟机实现里运行。这就是常说的“一次编写，到处运行”。
    - 提供了一个托管环境（Managed Runtime），能够代替我们处理一些代码中冗长而且容易出错的部分（如自动内存管理、垃圾回收等）。另外，托管环境还提供了诸如数组越界、动态类型、安全权限等动态检测。

### 2、Java虚拟机如何运行Java字节码？
Java 虚拟机将运行时内存区域划分为五个部分，分别为方法区、堆、PC 寄存器、Java 方法栈和本地方法栈。Java 程序编译而成的 class 文件，需要先加载至方法区中，方能在 Java 虚拟机中运行。


Java 字节码无法直接执行，需要Java 虚拟机将字节码翻译成机器码。在HotSpot里面，上述翻译过程有两种形式
- 解释执行：逐条将字节码翻译成机器码并执行。
- 即时编译（Just-In-Time compilation，JIT）：将一个方法中包含的所有字节码编译成机器码后再执行。


解释执行的优势在于无需等待编译，即时编译的优势在于实际运行速度更快。HotSpot 默认采用混合模式，综合了解释执行和即时编译两者的优点。它会先解释执行字节码，而后将其中反复执行的热点代码，以方法为单位
进行即时编译。在计算资源充足的情况下，字节码的解释执行和即时编译可同时进行。即时编译尚未完成时继续采用解释执行，而编译完成后的机器码会在下次调用该方法时启用，以替换原本的解释执行。

### 3、Java虚拟机的运行效率是怎么样的？
HotSpot 采用了多种技术来提升启动性能以及峰值性能，其中即时编译便是其中最重要的技术之一。为了满足不同用户场景的需求，HotSpot 内置了多个即时编译器：C1、C2 和 Graal（Java 10引入的实验性即时编译器）。
- C1（Client编译器）：面向的是对启动性能有要求的客户端 GUI 程序，采用的优化手段相对简单，因此编译时间较短。
- C2（Server编译器）：面向的是对峰值性能有要求的服务器端程序，采用的优化手段相对复杂，因此编译时间较长，但同时生成代码的执行效率较高。

从Java 7开始，HotSpot 默认采用分层编译的方式：热点方法首先会被 C1 编译，而后热点方法中的热点会进一步被 C2 编译。
